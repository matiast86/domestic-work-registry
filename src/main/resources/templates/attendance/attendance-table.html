<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{fragments/layout}"
>
  <head>
    <title>Registro de Asistencia</title>
  </head>

  <body>
    <div layout:fragment="content" class="container mt-5">
      <!-- Header + controls -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-0">Registro de Asistencia</h2>
          <small class="text-muted"
            >(Mes: <span th:text="${monthName}"></span>
            <span th:text="${year}"></span>)</small
          >
        </div>

        <!-- Month/year selector -->
        <form
          id="filterForm"
          th:action="@{/attendance/view/{scheduleId}(scheduleId=${scheduleId})}"
          method="get"
          class="d-flex align-items-center gap-2"
        >
          <select
            id="month"
            name="month"
            class="form-select form-select-sm"
            style="width: auto"
          >
            <option
              th:each="m : ${#numbers.sequence(1,12)}"
              th:value="${m}"
              th:text="${#temporals.create(2000,m,1).month.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).of('es'))}"
              th:selected="${m == month}"
            ></option>
          </select>

          <input
            type="number"
            id="year"
            name="year"
            th:value="${year}"
            class="form-control form-control-sm"
            style="width: 90px"
          />

          <button type="submit" class="btn btn-outline-primary btn-sm">
            Ver
          </button>
        </form>
      </div>

      <!-- Generate attendance -->
      <form
        id="generateForm"
        th:action="@{/attendance/create/{scheduleId}(scheduleId=${scheduleId})}"
        method="post"
        class="d-inline mb-3"
      >
        <input type="hidden" name="year" th:value="${year}" />
        <input type="hidden" name="month" th:value="${month}" />
        <input type="hidden" name="scheduleId" th:value="${scheduleId}" />

        <button type="submit" class="btn btn-success btn-sm">
          <i class="bi bi-plus-circle"></i> Generar asistencia
        </button>
      </form>

      <!-- New payslip creation -->
      <a
        th:href="@{/payslips/select/{contractId}(contractId=${contractId})}"
        class="btn btn-primary"
      >
        Generar Recibo de Sueldo
      </a>

      <!-- New payslip creation -->
      <a
        th:href="@{/payslips/list/{contractId}(contractId=${contractId})}"
        class="btn btn-primary"
      >
        Ver recibos de sueldo
      </a>

      <!-- Success message -->
      <div
        th:if="${successMessage}"
        class="alert alert-success alert-dismissible fade show mt-3"
        role="alert"
      >
        <span th:text="${successMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <a
          th:href="@{/attendance/view/{scheduleId}(scheduleId=${scheduleId}, year=${year}, month=${month - 1})}"
          th:if="${month > 1}"
          class="btn btn-outline-secondary btn-sm"
        >
          ← Mes anterior
        </a>

        <a
          th:href="@{/attendance/view/{scheduleId}(scheduleId=${scheduleId})}"
          class="btn btn-outline-primary btn-sm"
        >
          Volver al mes actual
        </a>

        <a
          th:href="@{/attendance/view/{scheduleId}(scheduleId=${scheduleId}, year=${year}, month=${month + 1})}"
          th:if="${month < 12}"
          class="btn btn-outline-secondary btn-sm"
        >
          Mes siguiente →
        </a>
      </div>

      <!-- Attendance Table -->
      <table class="table table-bordered align-middle mt-3">
        <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Día</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="record : ${attendanceRecords}">
            <td th:text="${#temporals.format(record.date, 'dd/MM/yyyy')}"></td>
            <td th:text="${record.date.dayOfWeek}"></td>

            <!-- Color-coded badge -->
            <td>
              <span
                class="badge fs-6 status-badge"
                th:text="${record.attendanceStatus.label}"
              ></span>
            </td>

            <!-- Update status -->
            <td>
              <form
                th:action="@{/attendance/updateStatus}"
                method="post"
                class="d-flex flex-column flex-sm-row gap-1 align-items-start align-items-sm-center"
              >
                <input type="hidden" name="recordId" th:value="${record.id}" />
                <input
                  type="hidden"
                  name="scheduleId"
                  th:value="${scheduleId}"
                />
                <select
                  name="attendanceStatus"
                  class="form-select form-select-sm"
                >
                  <option
                    th:each="s : ${T(com.springboot.domesticworkregistry.enums.AttendanceStatus).values()}"
                    th:value="${s}"
                    th:text="${s.label}"
                    th:selected="${s == record.attendanceStatus}"
                  ></option>
                </select>
                <button type="submit" class="btn btn-primary btn-sm">
                  Guardar
                </button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty message -->
      <div
        th:if="${#lists.isEmpty(attendanceRecords)}"
        class="alert alert-info mt-3"
      >
        No hay registros de asistencia para este mes.
      </div>
    </div>

    <script th:src="@{/js/attendance.js}" layout:fragment="scripts"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
